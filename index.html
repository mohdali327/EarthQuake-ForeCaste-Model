<!DOCTYPE html>
<html>
<head>
    <title>Earthquake Prediction Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 70vh;
            width: 100%;
        }
        .dashboard {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .controls {
            padding: 10px;
            background: #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .info-panel {
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            max-height: 20vh;
            overflow-y: auto;
        }
        .quake-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .quake-item:hover {
            background: #f5f5f5;
        }
        .high-risk { color: #e74c3c; font-weight: bold; }
        .medium-risk { color: #f39c12; }
        .low-risk { color: #27ae60; }
        button {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Earthquake Prediction Dashboard</h1>
            <p>Real-time earthquake data with ML predictions</p>
        </div>
        
        <div class="controls">
            <div>
                <button id="refresh-btn">Refresh Data</button>
                <span id="last-updated"></span>
            </div>
            <div id="prediction-result"></div>
        </div>
        
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>Recent Earthquakes</h3>
            <div id="quake-list"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Earthquake layer
        const quakeLayer = L.layerGroup().addTo(map);
        
        // Legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = `
                <h4>Risk Level</h4>
                <div><span class="high-risk">■</span> High (>70%)</div>
                <div><span class="medium-risk">■</span> Medium (30-70%)</div>
                <div><span class="low-risk">■</span> Low (<30%)</div>
            `;
            return div;
        };
        legend.addTo(map);
        
        // Load earthquake data
        function loadEarthquakes() {
            fetch('/api/earthquakes')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    // Update last updated time
                    document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                    
                    // Clear previous markers
                    quakeLayer.clearLayers();
                    
                    // Add new markers
                    data.features.forEach(quake => {
                        const coords = quake.geometry.coordinates;
                        const props = quake.properties;
                        
                        const marker = L.circleMarker([coords[1], coords[0]], {
                            radius: props.mag * 2,
                            fillColor: getRiskColor(props.prediction),
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(quakeLayer);
                        
                        marker.bindPopup(`
                            <b>Location:</b> ${props.place}<br>
                            <b>Magnitude:</b> ${props.mag.toFixed(1)}<br>
                            <b>Depth:</b> ${props.depth.toFixed(1)} km<br>
                            <b>Time:</b> ${new Date(props.time).toLocaleString()}<br>
                            <b>Risk Prediction:</b> <span class="${getRiskClass(props.prediction)}">${(props.prediction * 100).toFixed(1)}%</span>
                        `);
                    });
                    
                    // Update quake list
                    updateQuakeList(data.features);
                })
                .catch(error => {
                    console.error('Error loading earthquake data:', error);
                    alert('Failed to load earthquake data');
                });
        }
        
        // Update earthquake list in sidebar
        function updateQuakeList(quakes) {
            const list = document.getElementById('quake-list');
            list.innerHTML = '';
            
            quakes.sort((a, b) => new Date(b.properties.time) - new Date(a.properties.time));
            
            quakes.forEach(quake => {
                const props = quake.properties;
                const item = document.createElement('div');
                item.className = 'quake-item';
                item.innerHTML = `
                    <div><b>${props.mag.toFixed(1)}</b> - ${props.place}</div>
                    <small>${new Date(props.time).toLocaleString()} - 
                    <span class="${getRiskClass(props.prediction)}">${(props.prediction * 100).toFixed(1)}% risk</span></small>
                `;
                list.appendChild(item);
            });
        }
        
        // Get color based on risk prediction
        function getRiskColor(prediction) {
            if (prediction > 0.7) return '#e74c3c';  // red
            if (prediction > 0.3) return '#f39c12';  // orange
            return '#27ae60';  // green
        }
        
        // Get risk class for styling
        function getRiskClass(prediction) {
            if (prediction > 0.7) return 'high-risk';
            if (prediction > 0.3) return 'medium-risk';
            return 'low-risk';
        }
        
        // Handle map clicks for predictions
        map.on('click', function(e) {
            fetch(`/api/predict?lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const resultDiv = document.getElementById('prediction-result');
                    resultDiv.innerHTML = `
                        <div>Prediction for (${data.latitude.toFixed(2)}, ${data.longitude.toFixed(2)}): 
                        <span class="${getRiskClass(data.probability)}">${(data.probability * 100).toFixed(1)}% risk</span></div>
                    `;
                    
                    // Add temporary marker
                    const marker = L.circleMarker(e.latlng, {
                        radius: 8,
                        color: '#000',
                        weight: 1,
                        fillColor: getRiskColor(data.probability),
                        fillOpacity: 1
                    }).addTo(map);
                    
                    marker.bindPopup(`Predicted risk: ${(data.probability * 100).toFixed(1)}%`);
                    
                    // Remove after 5 seconds
                    setTimeout(() => {
                        map.removeLayer(marker);
                    }, 5000);
                });
        });
        
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', loadEarthquakes);
        
        // Initial load
        loadEarthquakes();
    </script>
</body>
</html>